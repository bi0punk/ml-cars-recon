**Optimized YOLO Streaming**

Este proyecto proporciona una soluci贸n optimizada para la captura y detecci贸n en tiempo real de veh铆culos (coches y autobuses) desde una c谩mara IP mediante un modelo YOLOv8.

---

## ndice

1. [Descripci贸n](#descripci贸n)
2. [Caracter铆sticas principales](#caracter铆sticas-principales)
3. [Requisitos](#requisitos)
4. [Instalaci贸n](#instalaci贸n)
5. [Estructura del proyecto](#estructura-del-proyecto)
6. [Configuraci贸n](#configuraci贸n)
7. [Uso](#uso)
8. [Detalles de implementaci贸n](#detalles-de-implementaci贸n)

   * Clase `OptimizedYOLOStreaming`
   * M茅todos clave
   * Optimizaci贸n y threading
9. [Controles en tiempo de ejecuci贸n](#controles-en-tiempo-de-ejecuci贸n)
10. [Mejoras y extensiones](#mejoras-y-extensiones)
11. [Licencia](#licencia)

---

## Descripci贸n

Este script conecta con un stream RTSP de una c谩mara IP, procesa los frames con un modelo YOLOv8 entrenado para detectar veh铆culos (`car` y `bus`), y guarda autom谩ticamente recortes de los veh铆culos que pasan por una zona central definida. Para minimizar la latencia y optimizar el rendimiento, utiliza:

* **Buffer y threading**: captura de frames en segundo plano con un buffer limitado.
* **Salto de frames**: solo procesa cada N-茅simo frame con el modelo.
* **Reducci贸n de resoluci贸n temporal** para inferencia m谩s r谩pida.

---

## Caracter铆sticas principales

* Detecci贸n en streaming de veh铆culos (`car`, `bus`).
* Guardado autom谩tico de im谩genes de veh铆culos en zona central.
* Configuraci贸n ajustable de resoluci贸n, FPS y salto de frames.
* M铆nima latencia mediante buffer de captura y subprocesos.
* Zona central configurable con alertas visuales (caja amarilla).
* Mensajes en consola para eventos clave.

---

## Requisitos

* Python 3.8+
* [ultralytics](https://pypi.org/project/ultralytics/)
* OpenCV (`cv2`)
* NumPy
* zoneinfo (incluido en Python 3.9+)

Instalaci贸n de dependencias:

```bash
pip install ultralytics opencv-python numpy
```

---

## Instalaci贸n

1. Clonar o descargar este repositorio.
2. Asegurarse de tener el modelo `yolov8n.pt` en la ra铆z del proyecto (o indicar otra ruta).
3. Instalar dependencias con `pip`.

---

## Estructura del proyecto

```
 optimized_yolo_streaming.py    # Script principal
 yolov8n.pt                     # Modelo YOLOv8 (pesos)
 capturas/                      # Carpeta donde se guardan im谩genes
```

---

## Configuraci贸n

* **RTSP URL**: en `if __name__ == "__main__"`, modificar `ip_camera_url` con la direcci贸n de la c谩mara.
* **Modelo**: por defecto `yolov8n.pt`, ajustar ruta en el constructor de `OptimizedYOLOStreaming`.
* **Salto de frames**: atributo `skip_frames` (por defecto 3).
* **Buffer de captura**: tama帽o de `frame_queue` (por defecto 3).
* **FPS**: `cap.set(cv2.CAP_PROP_FPS, 15)`.
* **Zona central**: definida mediante m谩rgenes relativos al centro del frame (`margen_x = 25% ancho`, `margen_y = 30% alto`).
* **Tipos de veh铆culos**: lista `vehiculos_interes = ['car','bus']`.

---

## Uso

```bash
python optimized_yolo_streaming.py
```

Al iniciar, ver谩 en consola:

```
 Iniciando streaming optimizado...
 Consejos:
   - Presiona 'q' para salir
   - Presiona 's' para saltar procesamiento YOLO por 10 frames
   - Los veh铆culos en la zona amarilla se guardar谩n autom谩ticamente
```

La ventana mostrar谩 el stream con detecciones y zona central resaltada.

---

## Detalles de implementaci贸n

### Clase `OptimizedYOLOStreaming`

Encapsula toda la l贸gica de:

* Conexi贸n y configuraci贸n de la c谩mara (`setup_camera`).
* Hilo de captura de frames (`capture_frames`).
* Procesamiento optimizado con YOLO (`process_with_yolo`).
* Dibujo de detecciones y gesti贸n de recortes (`draw_detections`, `save_vehicle_image`).
* Identificaci贸n de veh铆culos 煤nicos por bloque de p铆xeles (`get_vehicle_key`).

#### M茅todos clave

* **`setup_camera()`**: configura `cv2.VideoCapture` con buffer m铆nimo y FPS limitado.
* **`capture_frames(cap)`**: hilo que lee frames y mantiene un buffer FIFO.
* **`process_with_yolo(frame)`**: redimensiona el frame, ejecuta inferencia y filtra resultados.
* **`draw_detections(frame, detections)`**: dibuja cajas, texto, zona central y dispara guardado.
* **`save_vehicle_image(...)`**: recorta, crea carpeta `capturas` y guarda la imagen.
* **`run()`**: orquesta la inicializaci贸n, bucle principal, input de teclado y limpieza.

#### Optimizaci贸n y threading

1. **Thread de captura**: evita bloqueos en la lectura RTSP.
2. **Buffer peque帽os**: reduce latencia, siempre trabaja con el frame m谩s reciente.
3. **Skip frames**: solo inferencia cada N cuadros.
4. **Reducci贸n temporal de resoluci贸n**: velocidad vs precisi贸n.

---

## Controles en tiempo de ejecuci贸n

* **`q`**: salir del streaming.
* **`s`**: saltar inferencia YOLO durante los pr贸ximos 10 frames.

---

## Mejoras y extensiones

* Soporte para detecci贸n de m谩s clases (a帽adir a `vehiculos_interes`).
* Configuraci贸n v铆a archivo `.yaml` o par谩metros CLI.
* Interfaz web para visualizar stream y capturas.
* Integraci贸n con base de datos o notificaciones (Telegram, email).
* Ajuste din谩mico de resoluci贸n y FPS seg煤n carga.

---

## Licencia

Este proyecto se distribuye bajo la **Licencia MIT**. Ver `LICENSE` para m谩s detalles.
